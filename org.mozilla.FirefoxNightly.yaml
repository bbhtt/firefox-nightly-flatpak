app-id: org.mozilla.FirefoxNightly
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
base: org.mozilla.firefox.BaseApp
base-version: '20.08'
command: firefox-nightly
add-build-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .
    version: '20.08'
    autodownload: true
    autodelete: false

finish-args:
  - --device=dri
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --share=network
  # Smartcard access - Requires flatpak >= 1.3.2
  - '--socket=pcsc'
  # https://searchfox.org/mozilla-central/source/taskcluster/docker/firefox-flatpak/runme.sh#140
  - --require-version=0.11.1
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.freedesktop.FileManager1
  - --system-talk-name=org.freedesktop.NetworkManager
  - --talk-name=org.a11y.Bus
  - --talk-name=org.gnome.SessionManager
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.gtk.vfs.*
  - --filesystem=xdg-download
  - --own-name=org.mpris.MediaPlayer2.firefox.*
  - --own-name=org.mozilla.firefox.*
  # Persist the profiles
  - --persist=.mozilla
  - --filesystem=/etc/firefox/policies

cleanup-commands:
  - mkdir -p ${FLATPAK_DEST}/lib/ffmpeg

modules:
  - name: metadata
    buildsystem: simple
    build-commands:
      # Install the wrapper script to start it.
      - sed -i -e 's/__DEFAULT_WAYLAND__/true/'
        -e "s,\$MOZ_LIB_DIR/,${FLATPAK_DEST}/,g"
        -e "s,/__PREFIX__/bin/firefox,/__PREFIX__/bin/firefox-nightly,g"
        -e 's,/__PREFIX__,${FLATPAK_DEST},g'
        -e 's|%FLATPAK_ENV_VARS%|export TMPDIR="$XDG_CACHE_HOME/tmp"|'
        firefox.sh.in
      - 'install -Dm 755 firefox.sh.in ${FLATPAK_DEST}/bin/firefox-nightly'

      # Desktop Entry
      - sed -i -e "s,Exec=firefox ,Exec=firefox-nightly --name ${FLATPAK_ID} ,g"
        -e "s,Icon=firefox,Icon=${FLATPAK_ID},g"
        -e "s,Name=Firefox,Name=Firefox Nightly,g" firefox.desktop
      - install -Dm644 firefox.desktop
        ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

      # Search Provider
      - sed -i -e 's/firefox.desktop/${FLATPAK_ID}.desktop/' firefox-search-provider.ini
      - install -Dm644 firefox-search-provider.ini
        ${FLATPAK_DEST}/share/gnome-shell/search-providers/${FLATPAK_ID}-search-provider.ini
    sources:
      - type: git
        url: https://src.fedoraproject.org/rpms/firefox.git
        branch: main

  # Use the mozilla-provided metadata which has better presentation
  - name: metainfo
    buildsystem: simple
    build-options:
      env:
        VERSION: '87.0'
    build-commands:
      - sed -i
        -e "s/\$VERSION/${VERSION}/"
        -e "s/\$DATE/$(date '+%F')/"
        -e "s/org.mozilla.firefox/${FLATPAK_ID}/"
        -e "s/org.mozilla.firefox.desktop/${FLATPAK_ID}.desktop/g"
        org.mozilla.firefox.appdata.xml.in
      - install -Dm644 org.mozilla.firefox.appdata.xml.in ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
    sources:
      - type: file
        url: https://hg.mozilla.org/mozilla-central/raw-file/ffe056c7c496395708f643aeb00910622d689f64/taskcluster/docker/firefox-flatpak/org.mozilla.firefox.appdata.xml.in
        sha256: c46f8b4efd19a3ca34cfb3b3d61c5a178db5839694cfe2675fca4620eaa807ab
        dest-filename: org.mozilla.firefox.appdata.xml.in

  - name: run-mozilla
    buildsystem: simple
    build-commands:
      # Copy over run-mozilla.sh
      - install -Dm755 run-mozilla.sh ${FLATPAK_DEST}/firefox/run-mozilla.sh
    sources:
      - type: file
        url: https://hg.mozilla.org/mozilla-central/raw-file/ffe056c7c496395708f643aeb00910622d689f64/build/unix/run-mozilla.sh
        sha256: e7fadbe1e407362d492263b5dcb66b131605643611e200bf526b4a52ae2a636b
        dest-filename: run-mozilla.sh

  # https://bugzilla.mozilla.org/show_bug.cgi?id=1675312
  - name: default-preferences
    buildsystem: simple
    build-commands:
      - install -Dm644 default-preferences.js ${FLATPAK_DEST}/firefox/browser/defaults/preferences/default-preferences.js
    sources:
      - type: file
        url: https://hg.mozilla.org/mozilla-central/raw-file/ffe056c7c496395708f643aeb00910622d689f64/taskcluster/docker/firefox-flatpak/default-preferences.js
        sha256: 23faaa790d55eab99c7131008b47859c100297a74eb53530763e34c5f4eebed1
        dest-filename: default-preferences.js

  - name: policies
    buildsystem: simple
    build-commands:
      - install -Dm644 policies.json ${FLATPAK_DEST}/firefox/distribution/policies.json
    sources:
      - type: file
        url: https://hg.mozilla.org/mozilla-central/raw-file/ffe056c7c496395708f643aeb00910622d689f64/taskcluster/docker/firefox-flatpak/policies.json
        sha256: 35b68797094749f1d0553b3bc9f4154f323729c0d37345e472f249aab73be1bf
        dest-filename: policies.json

  # https://mozilla.design/firefox/logos-usage/
  # https://3u26hb1g25wn1xwo8g186fnd-wpengine.netdna-ssl.com/files/2019/10/Firefox-Browser-Nightly-Logo-Assets.zip
  - name: icons
    buildsystem: simple
    build-commands:
    - install -Dm644 "org.mozilla.FirefoxNightly.svg" "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg"

    # symbolic-icon
    - install -Dm644 "org.mozilla.FirefoxNightly-symbolic.svg"
      "${FLATPAK_DEST}/share/icons/hicolor/symbolic/apps/${FLATPAK_ID}-symbolic.svg"
    sources:
    - type: file
      url: https://hg.mozilla.org/mozilla-central/raw-file/tip/browser/branding/nightly/content/about-logo.svg
      sha256: 1bc3bb02384b61941ceedd4afae930e25efe288a404604c4b2c2aed6962663bb
      dest-filename: org.mozilla.FirefoxNightly.svg
    - type: file
      url: https://hg.mozilla.org/mozilla-central/raw-file/tip/browser/branding/official/content/identity-icons-brand.svg
      sha256: a9b8b4a0a1f4a7b4af77d5fc70c2686d624038909263c795ecc81e0aec7711e9
      dest-filename: org.mozilla.FirefoxNightly-symbolic.svg

    # https://searchfox.org/mozilla-central/source/taskcluster/docker/firefox-flatpak/runme.sh#52
    - name: distribution
      buildsystem: simple
      build-commands:
        - install -Dm644 desktop/flatpak/distribution/distribution.ini ${FLATPAK_DEST}/firefox/distribution/distribution.ini
      sources:
        - type: git
          url: https://github.com/mozilla-partners/flatpak.git
          branch: master
          commit: ae102c3789bd719c5ff11a67533115132281286e

  - name: firefox-nightly
    buildsystem: simple
    build-commands:
      ## Firefox explicitly supports python3, so its also our choice of interpreter. Note that there is no dependency on python.
      ## These scripts are only used when generating debug information in case of a crash, so not critical to the operation of firefox.
      - find . -name '*.py' -type f -exec sed -i -e
        's,!/usr/bin/python,!/usr/bin/python3,' -e 's,/usr/bin/env
        python,/usr/bin/env python3,' -s {} \;

      - for size in 16 32 48 64 128; do [[ -e
        "browser/chrome/icons/default/default${size}.png" ]] && install
        -Dm644 "browser/chrome/icons/default/default${size}.png"
        "${FLATPAK_DEST}/share/icons/hicolor/${size}x${size}/apps/${FLATPAK_ID}.png"; done

      # Blobs provided by Mozilla
      - cp -rf . ${FLATPAK_DEST}/firefox
      - rm -f ${FLATPAK_DEST}/firefox/firefox-config
      - rm -f ${FLATPAK_DEST}/firefox/update-settings.ini
    sources:
      - type: archive
        url: https://archive.mozilla.org/pub/firefox/nightly/latest-mozilla-central/firefox-88.0a1.en-US.linux-x86_64.tar.bz2
        sha256: a1d4b9fdd6d346a0e38e7e6091c81120cfc88c81a99f9f78b34023e84cc65e7d
        x-checker-data:
          type: html
          url: https://archive.mozilla.org/pub/firefox/nightly/latest-mozilla-central/
          version-pattern: "firefox-([a\\d\\.-]+).en-US.linux-x86_64.tar.bz2"
          url-template: https://archive.mozilla.org/pub/firefox/nightly/latest-mozilla-central/firefox-$version.en-US.linux-x86_64.tar.bz2
